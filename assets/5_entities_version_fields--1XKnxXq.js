import{J as d,M as e,N as m}from"./index-C4153gkO.js";import{d as w,e as D}from"./decrypt_curve25519_from_pass-BMc_o5KK.js";const J={version:5,name:"entities_version_fields",description:"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π version –∏ lastUpdated –∫–æ –≤—Å–µ–º —Å—É—â–Ω–æ—Å—Ç—è–º (accounts, rooms, friends)",fileName:"5_entities_version_fields.ts"};function V($){d("üì¶ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã 5: –°—Ö–µ–º–∞ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è"),d("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã 5 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")}async function O($){const{db:s,currentUser:c}=$;d(`üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö 5 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${c.id}`);const f=Date.now(),p=1;try{await I(s,c,p,f),await _(s,c,p,f),await A(s,c,p,f),d(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö 5 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${c.id}`)}catch(n){throw e(`‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö 5 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${c.id}:`,n),n}}async function I($,s,c,f){return new Promise((p,n)=>{try{const o=$.transaction(["accounts"],"readwrite"),g=o.objectStore("accounts"),a=g.getAll();a.onsuccess=async function(){try{const i=a.result.filter(t=>t.id===s.id);if(i.length===0){d(`‚úÖ –ù–µ—Ç accounts –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${s.id}`),p();return}d(`üìã –ù–∞–π–¥–µ–Ω–æ ${i.length} –∑–∞–ø–∏—Å–µ–π accounts –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏`);let r={total:i.length,processed:0,migrated:0,corrupted:0,alreadyVersioned:0,corruptedIds:[]};for(const t of i){r.processed++,m(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º account ${t.id} (${r.processed}/${r.total})`);const y=await w({pass:s.pass,cipherText:t.data});if(!y){r.corrupted++,r.corruptedIds.push(t.id),e(`üí• –ü–û–í–†–ï–ñ–î–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï: account ${t.id}`);continue}const l=JSON.parse(y);if(l.version!==void 0&&l.lastUpdated!==void 0){r.alreadyVersioned++,m(`‚è≠Ô∏è Account ${t.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}const h={...l,version:c,lastUpdated:f,date_updated:new Date},v=await D({pass:s.pass,message:JSON.stringify(h)}),R={id:t.id,data:v};g.put(R),r.migrated++,m(`‚úÖ Account ${t.id} –æ–±–Ω–æ–≤–ª–µ–Ω —Å version: ${c}`)}o.oncomplete=function(){d("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è accounts –∑–∞–≤–µ—Ä—à–µ–Ω–∞"),d(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ accounts: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${r.processed}, –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ ${r.migrated}, —É–∂–µ —Å –≤–µ—Ä—Å–∏–µ–π ${r.alreadyVersioned}, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ ${r.corrupted}`),r.corruptedIds.length>0&&e("üí• ID –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö accounts:",r.corruptedIds),p()},o.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ accounts:",o.error),n(o.error)}}catch(u){e("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ accounts:",u),n(u)}},a.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è accounts:",a.error),n(a.error)}}catch(o){e("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ accounts:",o),n(o)}})}async function _($,s,c,f){return new Promise((p,n)=>{try{const o=$.transaction(["rooms"],"readwrite"),g=o.objectStore("rooms"),a=g.getAll();a.onsuccess=async function(){try{const i=a.result.filter(t=>t.id.startsWith(s.id));if(i.length===0){d(`‚úÖ –ù–µ—Ç rooms –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${s.id}`),p();return}d(`üìã –ù–∞–π–¥–µ–Ω–æ ${i.length} –∑–∞–ø–∏—Å–µ–π rooms –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏`);let r={total:i.length,processed:0,migrated:0,corrupted:0,alreadyVersioned:0,corruptedIds:[]};for(const t of i){r.processed++,m(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º room ${t.id} (${r.processed}/${r.total})`);const y=await w({pass:s.pass,cipherText:t.data});if(!y){r.corrupted++,r.corruptedIds.push(t.id),e(`üí• –ü–û–í–†–ï–ñ–î–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï: room ${t.id}`);continue}const l=JSON.parse(y);if(l.version!==void 0&&l.lastUpdated!==void 0){r.alreadyVersioned++,m(`‚è≠Ô∏è Room ${t.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}const h={...l,version:c,lastUpdated:f},v=await D({pass:s.pass,message:JSON.stringify(h)}),R={id:t.id,data:v};g.put(R),r.migrated++,m(`‚úÖ Room ${t.id} –æ–±–Ω–æ–≤–ª–µ–Ω —Å version: ${c}`)}o.oncomplete=function(){d("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è rooms –∑–∞–≤–µ—Ä—à–µ–Ω–∞"),d(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ rooms: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${r.processed}, –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ ${r.migrated}, —É–∂–µ —Å –≤–µ—Ä—Å–∏–µ–π ${r.alreadyVersioned}, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ ${r.corrupted}`),r.corruptedIds.length>0&&e("üí• ID –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö rooms:",r.corruptedIds),p()},o.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ rooms:",o.error),n(o.error)}}catch(u){e("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ rooms:",u),n(u)}},a.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è rooms:",a.error),n(a.error)}}catch(o){e("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ rooms:",o),n(o)}})}async function A($,s,c,f){return new Promise((p,n)=>{try{const o=$.transaction(["friends"],"readwrite"),g=o.objectStore("friends"),a=g.getAll();a.onsuccess=async function(){try{const i=a.result.filter(t=>t.id.startsWith(s.id));if(i.length===0){d(`‚úÖ –ù–µ—Ç friends –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${s.id}`),p();return}d(`üìã –ù–∞–π–¥–µ–Ω–æ ${i.length} –∑–∞–ø–∏—Å–µ–π friends –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏`);let r={total:i.length,processed:0,migrated:0,corrupted:0,alreadyVersioned:0,corruptedIds:[]};for(const t of i){r.processed++,m(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º friend ${t.id} (${r.processed}/${r.total})`);const y=await w({pass:s.pass,cipherText:t.data});if(!y){r.corrupted++,r.corruptedIds.push(t.id),e(`üí• –ü–û–í–†–ï–ñ–î–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï: friend ${t.id}`);continue}const l=JSON.parse(y);if(l.version!==void 0&&l.lastUpdated!==void 0){r.alreadyVersioned++,m(`‚è≠Ô∏è Friend ${t.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}const h={...l,version:c,lastUpdated:f},v=await D({pass:s.pass,message:JSON.stringify(h)}),R={id:t.id,data:v};g.put(R),r.migrated++,m(`‚úÖ Friend ${t.id} –æ–±–Ω–æ–≤–ª–µ–Ω —Å version: ${c}`)}o.oncomplete=function(){d("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è friends –∑–∞–≤–µ—Ä—à–µ–Ω–∞"),d(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ friends: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${r.processed}, –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ ${r.migrated}, —É–∂–µ —Å –≤–µ—Ä—Å–∏–µ–π ${r.alreadyVersioned}, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ ${r.corrupted}`),r.corruptedIds.length>0&&e("üí• ID –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö friends:",r.corruptedIds),p()},o.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ friends:",o.error),n(o.error)}}catch(u){e("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ friends:",u),n(u)}},a.onerror=function(){e("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è friends:",a.error),n(a.error)}}catch(o){e("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ friends:",o),n(o)}})}export{O as migrationData,J as migrationInfo,V as migrationScheme};
