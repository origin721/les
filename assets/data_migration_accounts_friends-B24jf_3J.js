import{aC as e,aD as o,a6 as b,aE as P,aF as k,aG as p,aH as h,aI as j,aJ as D}from"./index-nyzUZv0R.js";async function g(n){e("üîë generate_keys_curve25519_from_password: –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π..."),e("üîë –ü–∞—Ä–æ–ª—å –¥–ª–∏–Ω–∞:",n==null?void 0:n.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("‚è∞ –ñ–¥–µ–º sodium.ready –≤ generate_keys...");const a=Date.now();await o.ready;const c=Date.now()-a;e("‚úÖ sodium.ready –≤ generate_keys –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",c,"–º—Å"),e("üé≤ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–ª—å...");const i=Date.now(),f=o.randombytes_buf(16),t=Date.now()-i;e("‚úÖ –°–æ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞",t,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –≤ –±–∞–π—Ç—ã...");const s=o.from_string(n);e("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª...");const r=Date.now(),u=o.crypto_generichash(32,s),y=Date.now()-r;e("‚úÖ –ö–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",y,"–º—Å"),e("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á...");const l=Date.now(),_=o.crypto_scalarmult_base(u),d=Date.now()-l;e("‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",d,"–º—Å"),e("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á...");const m=Date.now(),w=o.crypto_scalarmult_base(_),S=Date.now()-m;e("‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",S,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –≤ hex...");const K={privateKey:o.to_hex(_),publicKey:o.to_hex(w),salt:o.to_hex(f)};return e("‚úÖ generate_keys_curve25519_from_password –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"),K}async function B({pass:n,message:a}){try{e("üîê encrypt_curve25519_from_pass: –ù–∞—á–∏–Ω–∞–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ..."),e("üîê –†–∞–∑–º–µ—Ä –ø–∞—Ä–æ–ª—è:",n==null?void 0:n.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("üîê –†–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:",a==null?void 0:a.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("‚è∞ –ñ–¥–µ–º sodium.ready...");const c=Date.now();await o.ready;const i=Date.now()-c;e("‚úÖ sodium.ready –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",i,"–º—Å"),e("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏–∑ –ø–∞—Ä–æ–ª—è...");const f=Date.now(),{publicKey:t}=await g(n),s=Date.now()-f;e("‚úÖ –ö–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞",s,"–º—Å"),e("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á...");const r=typeof t=="string"?o.from_hex(t):t;e("üìù –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...");const u=o.from_string(a);e("üîê –í—ã–ø–æ–ª–Ω—è–µ–º crypto_box_seal...");const y=Date.now(),l=o.crypto_box_seal(u,r),_=Date.now()-y;e("‚úÖ crypto_box_seal –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",_,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ hex...");const d=o.to_hex(l);return e("‚úÖ encrypt_curve25519_from_pass –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ, —Ä–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:",d==null?void 0:d.length),d}catch(c){return b("‚ùå –û—à–∏–±–∫–∞ –≤ encrypt_curve25519_from_pass:",c),null}}async function I({cipherText:n,pass:a}){try{await o.ready;const{privateKey:c,publicKey:i}=await g(a),f=typeof c=="string"?o.from_hex(c):c,t=typeof i=="string"?o.from_hex(i):i,s=typeof n=="string"?o.from_hex(n):n,r=o.crypto_box_seal_open(s,t,f);return P(r)}catch{return null}}function v(n){const a=new Promise((c,i)=>{const f=s=>{c(s)},t=s=>{i(s)};k(s=>{a.finally(s);let r=indexedDB.open("store_v3",1);r.onupgradeneeded=function(u){const y=r.result,l=u.oldVersion??0,_=u.newVersion??1;p("üîÑ IndexDB onupgradeneeded:",{oldVersion:l,newVersion:_,existingStores:Array.from(y.objectStoreNames)});try{l===0&&_>=1&&(p("üì¶ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–≤—ã–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏"),y.objectStoreNames.contains("accounts")||(y.createObjectStore("accounts",{keyPath:"id"}),h("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ accounts —Å–æ–∑–¥–∞–Ω–æ")),y.objectStoreNames.contains("friends")||(y.createObjectStore("friends",{keyPath:"id"}),h("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ friends —Å–æ–∑–¥–∞–Ω–æ"))),p("üèÅ IndexDB –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:",Array.from(y.objectStoreNames))}catch(d){throw b("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ IndexedDB:",d),d}},r.onerror=function(){b("IndexDB openRequest error:",r.error),t(r.error)},r.onsuccess=function(){let u=r.result;n(u).then(()=>{u.close(),f(void 0)}).catch(t),u.onversionchange=function(){u.close()}},r.onblocked=function(){j("–°–æ–±—ã—Ç–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å"),t(new Error("Database connection blocked"))}})});return a}const x={accounts_by_id:{},friendsLibp2p:{},friends_by_account:{}};function N(){return new Promise((n,a)=>{v(c=>new Promise((i,f)=>{const r=c.transaction(["accounts"],"readwrite").objectStore("accounts").openCursor(),u=[];r.onsuccess=async function(y){const l=y.target.result;if(l){try{const _=new Set;for(let d of Object.values(x.accounts_by_id))_.add(d.pass);for(let d of _){const m=await I({pass:d,cipherText:l.value.data}),w=m?JSON.parse(m):null;w&&u.push(w)}}catch{}l.continue()}else n(u),i()}}))})}async function O(){return p("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è friendsByIds"),v(async n=>{try{const a=await N();let c=0;if(a.length===0){p("‚úÖ –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏");return}const i=n.transaction(["accounts"],"readwrite"),f=i.objectStore("accounts");for(const t of a){if(t.friendsByIds!==void 0){D(`‚è≠Ô∏è –ê–∫–∫–∞—É–Ω—Ç ${t.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ friendsByIds, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}D(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç ${t.id} (${t.namePub})`);const s={...t,friendsByIds:[],date_updated:new Date},r=await B({pass:t.pass,message:JSON.stringify(s)});f.put({id:t.id,data:r}),x.accounts_by_id[t.id]=s,c++}return new Promise((t,s)=>{i.oncomplete=function(){p(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–æ–≤–ª–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${c}`),t()},i.onerror=function(r){b("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤:",r),s(new Error(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ${JSON.stringify(r)}`))}})}catch(a){throw b("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ dataMigrationAccountsFriends:",a),a}})}export{O as default};
