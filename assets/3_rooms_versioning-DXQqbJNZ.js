import{J as r,N as m,M as i}from"./index-CyfUIhXi.js";import{d as h,e as D}from"./decrypt_curve25519_from_pass-CrepwTuL.js";const g=1,w={version:3,name:"rooms_versioning",description:"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è version –∫–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º rooms",fileName:"3_rooms_versioning.ts"};function N(p){r("üì¶ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã 3: –°—Ö–µ–º–∞ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è"),r("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã 3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")}async function O(p){const{db:l,currentUser:e}=p;return r(`üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö 3 –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${e.id}`),new Promise((u,c)=>{try{const t=l.transaction(["rooms"],"readwrite"),$=t.objectStore("rooms"),a=$.getAll();a.onsuccess=async function(){try{const n=a.result;if(n.length===0){r(`‚úÖ –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π rooms –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}`),u();return}r(`üìã –ù–∞–π–¥–µ–Ω–æ ${n.length} –∑–∞–ø–∏—Å–µ–π rooms –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`);let o={total:n.length,processed:0,migrated:0,corrupted:0,foreign:0,alreadyVersioned:0,corruptedIds:[]},y=0;for(const s of n){o.processed++,m(`üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å rooms ${s.id} (${o.processed}/${o.total})`);const f=await h({pass:e.pass,cipherText:s.data});if(!f){o.corrupted++,o.corruptedIds.push(s.id),i(`üí• –ü–û–í–†–ï–ñ–î–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï: rooms ${s.id} –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ ${e.id}`);continue}const d=JSON.parse(f);if(d.myAccId!==e.id){o.foreign++,m(`üë§ –ó–∞–ø–∏—Å—å rooms ${s.id} –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (${d.myAccId}), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}if(d.version!==void 0){o.alreadyVersioned++,m(`‚è≠Ô∏è –ó–∞–ø–∏—Å—å rooms ${s.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ version: ${d.version}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}const v={...d,version:g,date_updated:new Date},_=await D({pass:e.pass,message:JSON.stringify(v)}),I={id:s.id,data:_};$.put(I),y++,o.migrated++,m(`‚úÖ –ó–∞–ø–∏—Å—å rooms ${s.id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å version: ${g}`)}t.oncomplete=function(){r(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö 3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}`),r("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ rooms:"),r(`   - –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${o.total}`),r(`   - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${o.processed}`),r(`   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${o.migrated}`),r(`   - –£–∂–µ —Å –≤–µ—Ä—Å–∏–µ–π: ${o.alreadyVersioned}`),r(`   - –ß—É–∂–∏–µ –∑–∞–ø–∏—Å–∏: ${o.foreign}`),r(`   - –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ: ${o.corrupted}`),o.corruptedIds.length>0&&i("üí• ID –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π rooms:",o.corruptedIds),u()},t.onerror=function(){i(`‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}:`,t.error),c(t.error)}}catch(n){i(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}:`,n),c(n)}},a.onerror=function(){i(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ rooms –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}:`,a.error),c(a.error)}}catch(t){i(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ migrationData –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${e.id}:`,t),c(t)}})}export{O as migrationData,w as migrationInfo,N as migrationScheme};
