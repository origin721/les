import{ay as n,az as v,aA as x,q as f,aB as S}from"./index-clrAq5st.js";async function b(t){console.log("üîë generate_keys_curve25519_from_password: –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π..."),console.log("üîë –ü–∞—Ä–æ–ª—å –¥–ª–∏–Ω–∞:",t==null?void 0:t.length,"—Å–∏–º–≤–æ–ª–æ–≤"),console.log("‚è∞ –ñ–¥–µ–º sodium.ready –≤ generate_keys...");const r=Date.now();await n.ready;const c=Date.now()-r;console.log("‚úÖ sodium.ready –≤ generate_keys –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",c,"–º—Å"),console.log("üé≤ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–ª—å...");const a=Date.now(),y=n.randombytes_buf(16),o=Date.now()-a;console.log("‚úÖ –°–æ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞",o,"–º—Å"),console.log("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –≤ –±–∞–π—Ç—ã...");const s=n.from_string(t);console.log("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª...");const e=Date.now(),i=n.crypto_generichash(32,s),u=Date.now()-e;console.log("‚úÖ –ö–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",u,"–º—Å"),console.log("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á...");const _=Date.now(),d=n.crypto_scalarmult_base(i),l=Date.now()-_;console.log("‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",l,"–º—Å"),console.log("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á...");const g=Date.now(),p=n.crypto_scalarmult_base(d),h=Date.now()-g;console.log("‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",h,"–º—Å"),console.log("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –≤ hex...");const D={privateKey:n.to_hex(d),publicKey:n.to_hex(p),salt:n.to_hex(y)};return console.log("‚úÖ generate_keys_curve25519_from_password –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"),D}async function K({pass:t,message:r}){try{console.log("üîê encrypt_curve25519_from_pass: –ù–∞—á–∏–Ω–∞–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ..."),console.log("üîê –†–∞–∑–º–µ—Ä –ø–∞—Ä–æ–ª—è:",t==null?void 0:t.length,"—Å–∏–º–≤–æ–ª–æ–≤"),console.log("üîê –†–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:",r==null?void 0:r.length,"—Å–∏–º–≤–æ–ª–æ–≤"),console.log("‚è∞ –ñ–¥–µ–º sodium.ready...");const c=Date.now();await n.ready;const a=Date.now()-c;console.log("‚úÖ sodium.ready –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",a,"–º—Å"),console.log("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏–∑ –ø–∞—Ä–æ–ª—è...");const y=Date.now(),{publicKey:o}=await b(t),s=Date.now()-y;console.log("‚úÖ –ö–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞",s,"–º—Å"),console.log("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á...");const e=typeof o=="string"?n.from_hex(o):o;console.log("üìù –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...");const i=n.from_string(r);console.log("üîê –í—ã–ø–æ–ª–Ω—è–µ–º crypto_box_seal...");const u=Date.now(),_=n.crypto_box_seal(i,e),d=Date.now()-u;console.log("‚úÖ crypto_box_seal –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",d,"–º—Å"),console.log("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ hex...");const l=n.to_hex(_);return console.log("‚úÖ encrypt_curve25519_from_pass –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ, —Ä–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:",l==null?void 0:l.length),l}catch(c){return console.error("‚ùå –û—à–∏–±–∫–∞ –≤ encrypt_curve25519_from_pass:",c),null}}async function P({cipherText:t,pass:r}){try{await n.ready;const{privateKey:c,publicKey:a}=await b(r),y=typeof c=="string"?n.from_hex(c):c,o=typeof a=="string"?n.from_hex(a):a,s=typeof t=="string"?n.from_hex(t):t,e=n.crypto_box_seal_open(s,o,y);return v(e)}catch{return null}}function m(t){const r=new Promise((c,a)=>{const y=s=>{c(s)},o=s=>{a(s)};x(s=>{r.finally(s);let e=indexedDB.open("store_v3",1);e.onupgradeneeded=function(i){const u=e.result,_=i.oldVersion??0,d=i.newVersion??1;f("üîÑ IndexDB onupgradeneeded:",{oldVersion:_,newVersion:d,existingStores:Array.from(u.objectStoreNames)});try{_===0&&d>=1&&(f("üì¶ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–≤—ã–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏"),u.objectStoreNames.contains("accounts")||(u.createObjectStore("accounts",{keyPath:"id"}),f("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ accounts —Å–æ–∑–¥–∞–Ω–æ")),u.objectStoreNames.contains("friends")||(u.createObjectStore("friends",{keyPath:"id"}),f("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ friends —Å–æ–∑–¥–∞–Ω–æ"))),f("üèÅ IndexDB –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:",Array.from(u.objectStoreNames))}catch(l){throw console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ IndexedDB:",l),l}},e.onerror=function(){console.error("Error",e.error),o(e.error)},e.onsuccess=function(){let i=e.result;t(i).then(()=>{i.close(),y(void 0)}).catch(o),i.onversionchange=function(){i.close()}},e.onblocked=function(){S("–°–æ–±—ã—Ç–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å"),o(new Error("Database connection blocked"))}})});return r}const w={accounts_by_id:{},friendsLibp2p:{},friends_by_account:{}};function k(){return new Promise((t,r)=>{m(c=>new Promise((a,y)=>{const e=c.transaction(["accounts"],"readwrite").objectStore("accounts").openCursor(),i=[];e.onsuccess=async function(u){const _=u.target.result;if(_){try{const d=new Set;for(let l of Object.values(w.accounts_by_id))d.add(l.pass);for(let l of d){const g=await P({pass:l,cipherText:_.value.data}),p=g?JSON.parse(g):null;p&&i.push(p)}}catch{}_.continue()}else t(i),a()}}))})}async function B(){return f("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è friendsByIds"),m(async t=>{try{const r=await k();let c=0;if(r.length===0){f("‚úÖ –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏");return}const a=t.transaction(["accounts"],"readwrite"),y=a.objectStore("accounts");for(const o of r){if(o.friendsByIds!==void 0){f(`‚è≠Ô∏è –ê–∫–∫–∞—É–Ω—Ç ${o.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ friendsByIds, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}f(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç ${o.id} (${o.namePub})`);const s={...o,friendsByIds:[],date_updated:new Date},e=await K({pass:o.pass,message:JSON.stringify(s)});y.put({id:o.id,data:e}),w.accounts_by_id[o.id]=s,c++}return new Promise((o,s)=>{a.oncomplete=function(){f(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–æ–≤–ª–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${c}`),o()},a.onerror=function(e){console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤:",e),s(new Error(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ${JSON.stringify(e)}`))}})}catch(r){throw console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ dataMigrationAccountsFriends:",r),r}})}export{B as default};
