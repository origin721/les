import{ar as e,as as a,aj as b,at as I,au as j,av as p,aw as h,ax as P,ay as D}from"./index-BD3wD_iH.js";async function g(t){e("üîë generate_keys_curve25519_from_password: –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–ª—é—á–µ–π..."),e("üîë –ü–∞—Ä–æ–ª—å –¥–ª–∏–Ω–∞:",t==null?void 0:t.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("‚è∞ –ñ–¥–µ–º sodium.ready –≤ generate_keys...");const o=Date.now();await a.ready;const s=Date.now()-o;e("‚úÖ sodium.ready –≤ generate_keys –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",s,"–º—Å"),e("üé≤ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–ª—å...");const i=Date.now(),f=a.randombytes_buf(16),r=Date.now()-i;e("‚úÖ –°–æ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞",r,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –≤ –±–∞–π—Ç—ã...");const c=a.from_string(t);e("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª...");const n=Date.now(),u=a.crypto_generichash(32,c),d=Date.now()-n;e("‚úÖ –ö–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",d,"–º—Å"),e("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á...");const l=Date.now(),_=a.crypto_scalarmult_base(u),y=Date.now()-l;e("‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",y,"–º—Å"),e("üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á...");const m=Date.now(),w=a.crypto_scalarmult_base(_),S=Date.now()-m;e("‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞",S,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –≤ hex...");const K={privateKey:a.to_hex(_),publicKey:a.to_hex(w),salt:a.to_hex(f)};return e("‚úÖ generate_keys_curve25519_from_password –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"),K}async function k({pass:t,message:o}){try{e("üîê encrypt_curve25519_from_pass: –ù–∞—á–∏–Ω–∞–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ..."),e("üîê –†–∞–∑–º–µ—Ä –ø–∞—Ä–æ–ª—è:",t==null?void 0:t.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("üîê –†–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:",o==null?void 0:o.length,"—Å–∏–º–≤–æ–ª–æ–≤"),e("‚è∞ –ñ–¥–µ–º sodium.ready...");const s=Date.now();await a.ready;const i=Date.now()-s;e("‚úÖ sodium.ready –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",i,"–º—Å"),e("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏–∑ –ø–∞—Ä–æ–ª—è...");const f=Date.now(),{publicKey:r}=await g(t),c=Date.now()-f;e("‚úÖ –ö–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞",c,"–º—Å"),e("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á...");const n=typeof r=="string"?a.from_hex(r):r;e("üìù –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ...");const u=a.from_string(o);e("üîê –í—ã–ø–æ–ª–Ω—è–µ–º crypto_box_seal...");const d=Date.now(),l=a.crypto_box_seal(u,n),_=Date.now()-d;e("‚úÖ crypto_box_seal –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞",_,"–º—Å"),e("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ hex...");const y=a.to_hex(l);return e("‚úÖ encrypt_curve25519_from_pass –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ, —Ä–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:",y==null?void 0:y.length),y}catch(s){return b("‚ùå –û—à–∏–±–∫–∞ –≤ encrypt_curve25519_from_pass:",s),null}}async function B({cipherText:t,pass:o}){try{await a.ready;const{privateKey:s,publicKey:i}=await g(o),f=typeof s=="string"?a.from_hex(s):s,r=typeof i=="string"?a.from_hex(i):i,c=typeof t=="string"?a.from_hex(t):t,n=a.crypto_box_seal_open(c,r,f);return I(n)}catch{return null}}function v(t){const o=new Promise((s,i)=>{const f=c=>{s(c)},r=c=>{i(c)};j(c=>{o.finally(c);let n=indexedDB.open("store_v3",1);n.onupgradeneeded=function(u){const d=n.result,l=u.oldVersion??0,_=u.newVersion??1;p("üîÑ IndexDB onupgradeneeded:",{oldVersion:l,newVersion:_,existingStores:Array.from(d.objectStoreNames)});try{l===0&&_>=1&&(p("üì¶ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–≤—ã–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏"),d.objectStoreNames.contains("accounts")||(d.createObjectStore("accounts",{keyPath:"id"}),h("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ accounts —Å–æ–∑–¥–∞–Ω–æ")),d.objectStoreNames.contains("friends")||(d.createObjectStore("friends",{keyPath:"id"}),h("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ friends —Å–æ–∑–¥–∞–Ω–æ")),d.objectStoreNames.contains("rooms")||(d.createObjectStore("rooms",{keyPath:"id"}),h("‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ rooms —Å–æ–∑–¥–∞–Ω–æ"))),p("üèÅ IndexDB –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:",Array.from(d.objectStoreNames))}catch(y){throw b("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ IndexedDB:",y),y}},n.onerror=function(){b("IndexDB openRequest error:",n.error),r(n.error)},n.onsuccess=function(){let u=n.result;t(u).then(()=>{u.close(),f(void 0)}).catch(r),u.onversionchange=function(){u.close()}},n.onblocked=function(){P("–°–æ–±—ã—Ç–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å"),r(new Error("Database connection blocked"))}})});return o}const N=()=>({byId:{},async add(t,o){for(let s of t)this.byId[s.id]=s},async delete(t){for(let o of t)delete this.byId[o]},async getById(t){return this.byId[t]||null},async put(t){for(let o of t)this.byId[o.id]=o}}),x={accounts_by_id:{},friends_by_id:{},rooms:N()};function O(){return new Promise((t,o)=>{v(s=>new Promise((i,f)=>{const n=s.transaction(["accounts"],"readwrite").objectStore("accounts").openCursor(),u=[];n.onsuccess=async function(d){const l=d.target.result;if(l){try{const _=new Set;for(let y of Object.values(x.accounts_by_id))_.add(y.pass);for(let y of _){const m=await B({pass:y,cipherText:l.value.data}),w=m?JSON.parse(m):null;w&&u.push(w)}}catch{}l.continue()}else t(u),i()}}))})}async function R(){return p("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è friendsByIds"),v(async t=>{try{const o=await O();let s=0;if(o.length===0){p("‚úÖ –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏");return}const i=t.transaction(["accounts"],"readwrite"),f=i.objectStore("accounts");for(const r of o){if(r.friendsByIds!==void 0){D(`‚è≠Ô∏è –ê–∫–∫–∞—É–Ω—Ç ${r.id} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ friendsByIds, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);continue}D(`üîÑ –ú–∏–≥—Ä–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç ${r.id} (${r.namePub})`);const c={...r,friendsByIds:[],date_updated:new Date},n=await k({pass:r.pass,message:JSON.stringify(c)});f.put({id:r.id,data:n}),x.accounts_by_id[r.id]=c,s++}return new Promise((r,c)=>{i.oncomplete=function(){p(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–æ–≤–ª–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${s}`),r()},i.onerror=function(n){b("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤:",n),c(new Error(`–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: ${JSON.stringify(n)}`))}})}catch(o){throw b("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ dataMigrationAccountsFriends:",o),o}})}export{R as default};
