[На главную](../README.md)

# Работа протокола
версия протокола 1.0

## Подключение

1. Клиент подключается к server side event

1.1. Клиент получает данные всегда по server side event но отправляет post запросом
Но ответ от post запроса тоже может быть.

2. Клиент получает от сервера новый сгенерированный uuid сессии

2.1. Если клиент не получил uuid соединения
то сервер повторяет отправку uuid раз в 3 секунды

2.2. Если пользователь не авторизировался в течение 20 секунд, то сокет закрывается

3. Клиент после получения uuid сессии делает пост запрос
на авторизацию где передаёт свой публичный ключ и uuid сесси
которую получил от сервера.
Публичный ключ является id пользвователя по которому другие пользователи могут отправлять ему сообщения
 
3.1. Если пользователь получил ошибку что с таким публичным ключом сокет уже занят, то переводит сущьность клиента чей id является публичным ключом в статус неавторизован и нужно проходить заного авторизацию(в следующих пунктах).
Это случай который никогда не должен произойти


5. Регистрация пользователя на соките с таким же публичным ключом невозможна

3.2. После того как сервер зарегистрировал клиента (связь публичного ключа пользователя и его uuid сессии) публичный ключа пользователя невозможно поменять только переподключившись к server side event созвает новое соединение

4. После создание связи публичного ключа и uuid сессии идёт процесс регистрации где сервер генерирует 3 запроса с разными uuid которые нужно отправить серверу для регистрации, если всё совпадёт то клиент подтверждёт

4.1. сервер отправляет 3 провери последовательно не одновременно что бы замерить скорость



## Доставка сообщения от пользователя к пользователю


4.5. Сервер понимает от какого пользователя пришёл запрос по подписи


10. Одним post запросом можно отправить сообщения сразу нескольким клиентам 


6. Если сокет разорвался, новые запросы для кешированияы к нему не принимаются пока клиент не подключится к сокету

7. Время жизни сущьности клиент(по публичному ключу) с сохранением данных запроса которые недоставились ожидается минуту, если клиент не переподключился то все недошедшие данные очищаются из оперативки сервера

8. Запрос от 1 пользователя 1 клиенту на сервере кэшируется не больше 3х шт до подтверждение доставки



8.1. Системные запросы сервера никак не влияют на число закэшированых недосталенных данных (например ping)

9. При доставки по сокету

9.1 система пингует пользователя перед началом отправки сообщения что бы узнать примерную скорость клиента по длине строки отправляемого пинга и вообще учитывает среднее время других запросов по длине строки отправляемых данных и получённом подтверждение для примерного представления черз сколько доставятся данные

9.3. Если сервер не получил подтверждение о доставки сообщения, то сервер начинает пинговать клиента, после получения информации что клиент пингуется и ему не было доставлены данные высылает их повторно и ждёт подтверждения

9.4. запрос пользователя другому пользователю не может быть длинее определённой строки, если он большой то откланяет предложение передать эти данные клиенту(то есть клиент должен нарезать запросы сам)

