# –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π IndexedDB

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è IndexedDB, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–¥–∞ –º–∏–≥—Ä–∞—Ü–∏–π –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–∏—Å—Ç–µ–º–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ)
- **–§–∞–π–ª—ã**: `src/indexdb/migrations/migration_v*.ts`
- **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤–æ –≤—Ä–µ–º—è `onupgradeneeded` 
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î (object stores, –∏–Ω–¥–µ–∫—Å—ã)

### 2. –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ)
- **–§–∞–π–ª—ã**: `src/indexdb/migrations/data_migrations/data_migration_*.ts`
- **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```typescript
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
const migrationModule = await import(`./data_migrations/${migration.fileName}.js`);
const migrationFunction = migrationModule.default;
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç.

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π

```typescript
// –í–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage
const currentVersion = getCurrentDataVersion(); // –ò–∑ localStorage
const targetVersion = Math.max(...DATA_MIGRATION_REGISTRY.map(m => m.toVersion), 0);

if (currentVersion < targetVersion) {
  await runDataMigrations(currentVersion, targetVersion);
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/indexdb/migrations/
‚îú‚îÄ‚îÄ types.ts                    # –¢–∏–ø—ã –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ index.ts                    # –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π —Å—Ö–µ–º—ã (–±—É–¥—É—â–µ–µ)
‚îú‚îÄ‚îÄ data_migrations.ts          # –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ migration_v0_to_v1.ts      # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã
‚îî‚îÄ‚îÄ data_migrations/
    ‚îî‚îÄ‚îÄ data_migration_accounts_friends.ts  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏

```typescript
// src/indexdb/migrations/data_migrations/data_migration_example.ts
export default async function dataMigrationExample(): Promise<void> {
  console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é: –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏');
  
  // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
  // –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å indexdb_wrapper, back_store, etc.
}
```

### 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ —Ä–µ–µ—Å—Ç—Ä–µ

```typescript
// src/indexdb/migrations/data_migrations.ts
export const DATA_MIGRATION_REGISTRY: MigrationInfo[] = [
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
  {
    fromVersion: 1,
    toVersion: 2,
    description: '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏',
    fileName: 'data_migration_example'
  },
];
```

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
2. –ù–∞–π–¥–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π
4. –í—ã–ø–æ–ª–Ω–∏—Ç –∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **Code splitting**: –ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

### üîß –ì–∏–±–∫–æ—Å—Ç—å
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è - –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

```typescript
// src/processes/app_processes_mount.ts
import { autoRunDataMigrations } from "../indexdb/migrations/data_migrations";

onMount(async () => {
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π)
  await autoRunDataMigrations();
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
});
```

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```
üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: 0 -> 1
üöÄ –ù–∞–π–¥–µ–Ω–æ 1 –º–∏–≥—Ä–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö: data_migration_accounts_friends
‚ö° –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö: –ú–∏–≥—Ä–∞—Ü–∏—è accounts –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è friendsByIds
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö data_migration_accounts_friends –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –í–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ 1
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, **–¥–∞, –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –±–∞–∑—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** (–¥–ª—è –¥–∞–Ω–Ω—ã—Ö), –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –ø—Ä–æ–µ–∫—Ç–∞. –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
