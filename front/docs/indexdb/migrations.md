# –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π IndexedDB

–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ö–µ–º—ã –∏ –¥–∞–Ω–Ω—ã—Ö IndexedDB —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–¥–∞ –∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª**, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
- **–ú–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã** (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è) - –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
- **–ú–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö** (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è) - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞

```typescript
// –ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
const module = await import(`./combined/${fileName}.ts`);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ bundle
- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ï—Å–ª–∏ –ë–î —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞, –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤–æ–æ–±—â–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–∞:

```typescript
// src/indexdb/main_les_store_v1/migrations/combined/2_example.ts

/**
 * –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏–∏
 */
export const migrationInfo = {
  version: 2,                              // –ù–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
  name: 'example',                         // –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
  description: '–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π',       // –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  fileName: '2_example.ts'                 // –ò–º—è —Ñ–∞–π–ª–∞
};

/**
 * –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ onupgradeneeded —Å–æ–±—ã—Ç–∏—è IndexedDB
 */
export function migrationScheme(db: IDBDatabase): void {
  // –°–æ–∑–¥–∞–Ω–∏–µ object stores
  if (!db.objectStoreNames.contains('settings')) {
    const store = db.createObjectStore('settings', { keyPath: 'id' });
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
    store.createIndex('byCategory', 'category', { unique: false });
    store.createIndex('byKey', 'key', { unique: true });
  }
  
  // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö stores (—á–µ—Ä–µ–∑ transaction –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞)
}

/**
 * –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è) 
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã
 */
export async function migrationData(db: IDBDatabase): Promise<void> {
  return new Promise<void>((resolve, reject) => {
    try {
      const transaction = db.transaction(['accounts', 'settings'], 'readwrite');
      const accountsStore = transaction.objectStore('accounts');
      const settingsStore = transaction.objectStore('settings');
      
      // –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      const getAllRequest = accountsStore.getAll();
      
      getAllRequest.onsuccess = () => {
        const accounts = getAllRequest.result;
        
        // –ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        accounts.forEach(account => {
          settingsStore.add({
            id: `${account.id}_theme`,
            accountId: account.id,
            category: 'appearance',
            key: 'theme',
            value: 'light'
          });
        });
        
        resolve();
      };
      
      getAllRequest.onerror = () => reject(getAllRequest.error);
      
    } catch (error) {
      reject(error);
    }
  });
}
```

## –°–æ–≥–ª–∞—à–µ–Ω–∏—è –æ–± –∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏

### –§–∞–π–ª—ã
- –§–æ—Ä–º–∞—Ç: `{–≤–µ—Ä—Å–∏—è}_{–Ω–∞–∑–≤–∞–Ω–∏–µ}.ts`
- –í–µ—Ä—Å–∏–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0 –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç—Ä–∞–∂–∞—Ç—å —Å—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä—ã:**
- `0_initialization.ts` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `1_accounts_friends.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –¥—Ä—É–∑–µ–π
- `2_add_settings_store.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `3_optimize_indexes.ts` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
- `migrationInfo` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏–∏
- `migrationScheme` - —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã
- `migrationData` - —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ combined/
touch src/indexdb/main_les_store_v1/migrations/combined/2_add_settings.ts
```

### 2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω –≤—ã—à–µ, –∑–∞–ø–æ–ª–Ω–∏–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É.

### 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –≤ —Ä–µ–µ—Å—Ç—Ä–µ

```typescript
// src/indexdb/main_les_store_v1/migrations/migrations.ts

const MIGRATIONS_REGISTRY: Record<number, string> = {
  0: '0_initialization',
  1: '1_accounts_friends',
  2: '2_add_settings',     // ‚Üê –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
  // 3: '3_next_migration', // ‚Üê –ë—É–¥—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
};
```

### 4. –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞:
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î
- –ù–∞–π–¥–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç –∫–æ–¥ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
- –í—ã–ø–æ–ª–Ω–∏—Ç –∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

## –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```typescript
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
const currentVersion = await getCurrentDbVersion(dbName);
const targetVersion = getMaxVersion();
```

### 2. –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞
```typescript
// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
const preloadedMigrations = await preloadMigrations(currentVersion, targetVersion);
```

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
```typescript
// –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ onupgradeneeded
runSchemaMigrations(db, oldVersion, newVersion, preloadedMigrations);
```

### 4. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
```typescript
// –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ë–î
await runDataMigrations(db, oldVersion, newVersion, preloadedMigrations);
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã

‚úÖ **–î–µ–ª–∞–π—Ç–µ:**
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ stores –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
- –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ store
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è stores –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ

‚ùå **–ù–µ –¥–µ–ª–∞–π—Ç–µ:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `migrationScheme`
- –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã
- –£–¥–∞–ª–µ–Ω–∏–µ stores –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

```typescript
export function migrationScheme(db: IDBDatabase): void {
  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
  if (!db.objectStoreNames.contains('newStore')) {
    const store = db.createObjectStore('newStore', { keyPath: 'id' });
    store.createIndex('byDate', 'createdAt', { unique: false });
    prodInfo('‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ newStore —Å–æ–∑–¥–∞–Ω–æ');
  }
  
  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
  // await someAsyncOperation();
}
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

‚úÖ **–î–µ–ª–∞–π—Ç–µ:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–º–æ—â—å—é try-catch
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

‚ùå **–ù–µ –¥–µ–ª–∞–π—Ç–µ:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ Promise

```typescript
export async function migrationData(db: IDBDatabase): Promise<void> {
  return new Promise<void>((resolve, reject) => {
    try {
      const transaction = db.transaction(['accounts'], 'readwrite');
      const store = transaction.objectStore('accounts');
      
      transaction.oncomplete = () => {
        prodInfo('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
        resolve();
      };
      
      transaction.onerror = () => {
        prodError('‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', transaction.error);
        reject(transaction.error);
      };
      
      // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
      
    } catch (error) {
      prodError('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
      reject(error);
    }
  });
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:

```
üîÑ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π –º–∏–≥—Ä–∞—Ü–∏–π: {oldVersion: 0, newVersion: 2}
üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –º–∏–≥—Ä–∞—Ü–∏–∏: 0_initialization
‚úÖ –ú–æ–¥—É–ª—å –º–∏–≥—Ä–∞—Ü–∏–∏ 0_initialization –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ
üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –º–∏–≥—Ä–∞—Ü–∏–∏: 1_accounts_friends  
‚úÖ –ú–æ–¥—É–ª—å –º–∏–≥—Ä–∞—Ü–∏–∏ 1_accounts_friends –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ
‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ 2 –º–æ–¥—É–ª–µ–π –º–∏–≥—Ä–∞—Ü–∏–π

üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —Å—Ö–µ–º—ã IndexedDB: {oldVersion: 0, newVersion: 2}
üìã –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã —Å –≤–µ—Ä—Å–∏–∏ 0 –¥–æ 1
üì¶ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã 0: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â
‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ accounts —Å–æ–∑–¥–∞–Ω–æ
‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ friends —Å–æ–∑–¥–∞–Ω–æ  
‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ rooms —Å–æ–∑–¥–∞–Ω–æ
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã 0_initialization –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞ 5–º—Å

üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö IndexedDB: {oldVersion: 0, newVersion: 2}
üìã –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö —Å –≤–µ—Ä—Å–∏–∏ 0 –¥–æ 1
üîÑ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è friendsByIds
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–ø–æ–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö 1_accounts_friends –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞ 12–º—Å
üèÅ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö IndexedDB –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏
```typescript
import { getCurrentDbVersion, getMaxVersion } from './migrations';

const currentVersion = await getCurrentDbVersion('MainLesStore');
const targetVersion = getMaxVersion();
console.log(`–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${currentVersion}, —Ü–µ–ª–µ–≤–∞—è: ${targetVersion}`);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
```typescript
import { hasMigration, getAvailableMigrations } from './migrations';

if (hasMigration(5)) {
  console.log('–ú–∏–≥—Ä–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏ 5 –¥–æ—Å—Ç—É–ø–Ω–∞');
}

const allMigrations = getAvailableMigrations();
console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:', allMigrations);
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:

- **–û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
- **–û—à–∏–±–∫–∏ —Å—Ö–µ–º—ã** - –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º stores/–∏–Ω–¥–µ–∫—Å–æ–≤  
- **–û—à–∏–±–∫–∏ –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **–û—à–∏–±–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏:
1. –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
2. –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
3. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `UPDATE_FAILED`
4. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ –∏–ª–∏ –æ—Ç–∫–∞—Ç–µ

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- –ö–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ú–æ–¥—É–ª–∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —É–º–µ–Ω—å—à–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Å—Ö–µ–º–∞, —Ç–∞–∫ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
- –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ IndexedDB —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
