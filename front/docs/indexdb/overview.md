# Система IndexedDB - Общий обзор

Система IndexedDB в проекте представляет собой современное решение для работы с клиентской базой данных, включающее в себя продвинутую систему миграций, управление состояниями БД и асинхронную загрузку кода.

## Основные компоненты

### 1. Управление состояниями БД (`db_state_manager_v1/`)
- Отдельная база данных для отслеживания состояний всех баз данных
- Предотвращение одновременных обновлений
- Мониторинг статусов миграций

### 2. Основная база данных (`main_les_store_v1/`)
- Wrapper для работы с IndexedDB
- Интеграция с системой состояний
- Автоматические миграции

### 3. Система миграций (`main_les_store_v1/migrations/`)
- **Комбинированные миграции** - единый файл для схемы и данных
- **Асинхронная загрузка** - код миграций загружается только при необходимости
- **Предзагрузка миграций** - заблаговременная подготовка модулей

## Архитектура миграций

```
src/indexdb/main_les_store_v1/migrations/
├── migrations.ts              # Основная логика системы миграций
├── types.ts                   # TypeScript типы
└── combined/                  # Комбинированные миграции
    ├── README.md              # Документация по структуре файлов
    ├── 0_initialization.ts    # Инициализация БД
    ├── 1_accounts_friends.ts  # Добавление связей аккаунтов
    └── ...                    # Новые миграции
```

### 🏗️ Диаграмма архитектуры компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                     Приложение (App)                           │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                indexdb_wrapper()                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Connection Mgr  │  │  Order Control  │  │  Error Handler  │ │
│  │                 │  │                 │  │                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│               Система состояний                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │          db_states (отдельная БД)                          │ │
│  │                                                             │ │
│  │  main_les_store_v1: { status: "IDLE", version: 2 }         │ │
│  │  other_db: { status: "UPDATE_STARTED", version: 1 }        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│               Основная БД (main_les_store_v1)                  │
│                                                                 │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │   accounts    │  │     rooms     │  │   settings    │       │
│  │               │  │               │  │               │       │
│  │  [user data]  │  │ [chat rooms]  │  │ [app config]  │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Система миграций                               │
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Анализатор    │  │   Загрузчик     │  │   Исполнитель   │ │
│  │   версий        │  │   миграций      │  │   миграций      │ │
│  │                 │  │                 │  │                 │ │
│  │  v1 → v2 ?     │  │  import('2.ts') │  │  scheme + data  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 🔄 Схема жизненного цикла миграций

```
    [Приложение запускается]
             │
             ▼
    ┌─────────────────┐
    │  Проверка БД    │ ──────┐
    │   существует?   │       │
    └─────────────────┘       │
             │                │
             ▼                │
         [БД есть]            │ [БД нет]
             │                │
             ▼                ▼
    ┌─────────────────┐   ┌─────────────────┐
    │ Проверка версии │   │   Создание БД   │
    │  текущая vs     │   │  + инициализация│
    │   требуемая     │   │   (миграция 0)  │
    └─────────────────┘   └─────────────────┘
             │                     │
             ▼                     │
      [v1 < v2?]                   │
             │                     │
    ┌────────┴────────┐             │
    │                 │             │
 [Да]              [Нет]            │
    │                 │             │
    ▼                 ▼             │
┌─────────────────┐ ┌─────────────────┐  │
│   Миграция      │ │  БД готова к    │  │
│   требуется     │ │   работе        │  │
└─────────────────┘ └─────────────────┘  │
    │                     ▲             │
    ▼                     │             │
┌─────────────────┐       │             │
│ Статус:         │       │             │
│ UPDATE_STARTED  │       │             │
└─────────────────┘       │             │
    │                     │             │
    ▼                     │             │
┌─────────────────┐       │             │
│ Загрузка кода   │       │             │
│ миграций        │       │             │
│ (async import)  │       │             │
└─────────────────┘       │             │
    │                     │             │
    ▼                     │             │
┌─────────────────┐       │             │
│ Выполнение      │       │             │
│ миграций        │───────┘             │
│ (схема + данные)│                     │
└─────────────────┘                     │
                                        │
                                        ▼
                                 ┌─────────────────┐
                                 │  БД готова к    │
                                 │    работе       │
                                 │                 │
                                 │ Статус: IDLE    │
                                 └─────────────────┘
```

### 📊 Диаграмма статусов базы данных

```
                    [Запуск приложения]
                            │
                            ▼
                    ┌─────────────────┐
                    │      IDLE       │ ◄─────────┐
                    │                 │           │
                    │ • БД готова     │           │
                    │ • Можно читать  │           │
                    │ • Можно писать  │           │
                    └─────────────────┘           │
                            │                     │
                   [Нужна миграция]               │
                            │                     │
                            ▼                     │
                    ┌─────────────────┐           │
                    │ UPDATE_STARTED  │           │
                    │                 │           │
                    │ • БД блокирована│           │
                    │ • Выполняется   │           │
                    │   миграция      │           │
                    └─────────────────┘           │
                            │                     │
                    ┌───────┴───────┐             │
                    │               │             │
               [Успех]           [Ошибка]         │
                    │               │             │
                    ▼               ▼             │
            ┌─────────────────┐ ┌─────────────────┐
            │ UPDATE_SUCCESS  │ │ UPDATE_FAILED   │
            │                 │ │                 │
            │ • Миграция OK   │ │ • Нужен откат   │
            │ • Переход в     │ │ • Ручное        │
            │   IDLE          │ │   вмешательство │
            └─────────────────┘ └─────────────────┘
                    │                     │
                    └─────────────────────┼─────────┐
                                          │         │
                                          ▼         │
                                  ┌─────────────────┐│
                                  │   CORRUPTED     ││
                                  │                 ││
                                  │ • БД повреждена ││
                                  │ • Нужна         ││
                                  │   пересборка    ││
                                  └─────────────────┘│
                                                     │
                                    [Восстановление] │
                                                     │
                                                     ▼
                                          ┌─────────────────┐
                                          │ Экстренная      │
                                          │ миграция        │
                                          │                 │
                                          │ • Полная        │
                                          │   пересборка БД │
                                          └─────────────────┘
                                                     │
                                                     └─────────┘
```

## Ключевые особенности

### 🚀 Производительность
- **Code Splitting**: Код миграций загружается динамически только при необходимости
- **Предзагрузка**: Система заранее определяет и загружает только нужные миграции
- **Кеширование**: Если БД уже в актуальной версии, миграции не загружаются

### 🔒 Надежность
- **Управление состояниями**: Предотвращение одновременных обновлений
- **Экстренная миграция**: Восстановление при рассинхронизации версий
- **Детальное логирование**: Полная информация о ходе миграций

### 🛠 Гибкость
- **Комбинированные миграции**: Схема и данные в одном файле
- **Асинхронность**: Сложные операции с данными после обновления схемы
- **Модульность**: Каждая миграция - отдельный модуль

## Статусы обновления БД

| Статус | Описание |
|--------|----------|
| `IDLE` | База в обычном состоянии |
| `UPDATE_STARTED` | Началось обновление |
| `UPDATE_SUCCESS` | Обновление завершено успешно |
| `UPDATE_FAILED` | Обновление завершилось с ошибкой |
| `CORRUPTED` | База повреждена |

## Процесс работы

1. **Инициализация**: Проверка текущей версии БД без её обновления
2. **Анализ**: Определение необходимых миграций
3. **Предзагрузка**: Асинхронная загрузка модулей миграций
4. **Миграция схемы**: Синхронное обновление структуры БД
5. **Миграция данных**: Асинхронное преобразование существующих данных
6. **Финализация**: Обновление статуса и версии БД

## Быстрый старт

### Обычная работа с БД
```typescript
import { indexdb_wrapper } from './main_les_store_v1/indexdb_wrapper';

await indexdb_wrapper(async (db) => {
  // Работа с базой данных
  const transaction = db.transaction(['accounts'], 'readwrite');
  // ...
});
```

### Проверка состояния БД
```typescript
import { getDbState } from './db_state_manager_v1/db_state_manager';
import { DB_NAMES } from './constants';

const state = await getDbState(DB_NAMES.MAIN_LES_STORE);
console.log('Статус базы:', state?.status);
```

### Создание новой миграции
```typescript
// Создайте файл: combined/2_new_feature.ts
export const migrationInfo = {
  version: 2,
  name: 'new_feature',
  description: 'Добавление новой функциональности',
  fileName: '2_new_feature.ts'
};

export function migrationScheme(db: IDBDatabase): void {
  // Изменения схемы БД
}

export async function migrationData(db: IDBDatabase): Promise<void> {
  // Миграция данных
}
```

## Дальнейшее чтение

- [Система миграций](./migrations.md) - детальное описание миграций
- [Управление состояниями](./state-management.md) - работа с состояниями БД
- [Примеры использования](./examples.md) - практические примеры
