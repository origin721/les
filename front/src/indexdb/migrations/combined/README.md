# Система миграций IndexedDB

Этот каталог содержит комбинированные миграции, которые включают в себя как миграции схемы (синхронные), так и миграции данных (асинхронные).

## Структура файла миграции

Каждый файл миграции должен экспортировать следующие элементы:

```typescript
// Информация о миграции
export const migrationInfo = {
  version: 0, // Номер версии
  name: 'migration_name', // Название миграции
  description: 'Описание того, что делает миграция',
  fileName: '0_migration_name.ts' // Имя файла
};

// Синхронная миграция схемы (выполняется в onupgradeneeded)
export function migrationScheme(db: IDBDatabase): void {
  // Код создания/изменения схемы БД
  // Например: создание объектных хранилищ, индексов
}

// Асинхронная миграция данных (выполняется после создания схемы)
export async function migrationData(db: IDBDatabase): Promise<void> {
  // Код миграции существующих данных
  // Например: обновление записей, преобразование структур данных
}
```

## Соглашения об именовании

- Файлы миграций должны именоваться как `{версия}_{название}.ts`
- Версии начинаются с 0 и увеличиваются последовательно
- Название должно быть кратким и описательным

Примеры:
- `0_initialization.ts` - инициализация базы данных
- `1_accounts_friends.ts` - добавление связи аккаунтов и друзей

## Добавление новой миграции

1. Создайте новый файл в каталоге `combined/` с правильным именем
2. Реализуйте необходимые экспорты (`migrationInfo`, `migrationScheme`, `migrationData`)
3. Добавьте запись в `MIGRATIONS_REGISTRY` в файле `../migrations.ts`:

```typescript
const MIGRATIONS_REGISTRY: Record<number, string> = {
  0: '0_initialization',
  1: '1_accounts_friends',
  // 2: '2_new_migration', // <- добавьте сюда
};
```

## Принципы работы

### Миграция схемы (`migrationScheme`)
- Выполняется синхронно в контексте `onupgradeneeded` события IndexedDB
- Может создавать/удалять объектные хранилища и индексы
- Должна быть быстрой и надежной
- Не может выполнять асинхронные операции

### Миграция данных (`migrationData`)
- Выполняется асинхронно после завершения миграции схемы
- Может читать/изменять данные в базе
- Может выполнять сложные операции преобразования данных
- Поддерживает Promise/async-await

## Система асинхронной загрузки

Система автоматически:

1. **Определяет текущую версию БД** без её обновления
2. **Предварительно загружает** только нужные модули миграций
3. **Выполняет миграции схемы** синхронно в `onupgradeneeded`
4. **Выполняет миграции данных** асинхронно после открытия БД

## Преимущества

- ✅ **Асинхронная загрузка**: Модули миграций загружаются только при необходимости
- ✅ **Единый файл**: И схема, и данные в одном месте
- ✅ **Безопасность**: Получение версии БД без onupgradeneeded
- ✅ **Читаемость**: Четкое разделение между схемой и данными
- ✅ **Производительность**: Только нужные миграции загружаются в память
