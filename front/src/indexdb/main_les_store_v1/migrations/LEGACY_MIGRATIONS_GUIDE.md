# üì¶ –°–∏—Å—Ç–µ–º–∞ Legacy –ú–∏–≥—Ä–∞—Ü–∏–π - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ legacy –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—É—Ç–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:

- **Legacy –º–∏–≥—Ä–∞—Ü–∏–∏** (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏) - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** (–Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏) - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ–≥–¥–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
migrations/
‚îú‚îÄ‚îÄ MIGRATIONS_REGISTRY.ts           # –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–µ—Å—Ç—Ä (–Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏)
‚îú‚îÄ‚îÄ LEGASY_MIGRATIONS_REGISTRY.ts    # Legacy —Ä–µ–µ—Å—Ç—Ä (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
‚îî‚îÄ‚îÄ migrations.ts                    # –õ–æ–≥–∏–∫–∞ —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
```

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
1. **MIN_CURRENT_VERSION** - –≥—Ä–∞–Ω–∏—á–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ–∂–¥—É legacy –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
2. –ü—Ä–∏ `oldVersion < MIN_CURRENT_VERSION` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è legacy —Ä–µ–µ—Å—Ç—Ä
3. –ü—Ä–∏ `oldVersion >= MIN_CURRENT_VERSION` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–µ—Å—Ç—Ä

## ‚ö° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **üöÄ –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç legacy –∫–æ–¥
- **üì¶ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è bundle**: –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  
- **üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
- **üéØ –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: Legacy –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üìã –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–≤–µ—Ä—Å–∏—è 0 ‚Üí 2)
```typescript
// oldVersion = 0, newVersion = 2, MIN_CURRENT_VERSION = 0
// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ MIGRATIONS_REGISTRY (–±—ã—Å—Ç—Ä–æ)
// ‚ùå Legacy —Ä–µ–µ—Å—Ç—Ä –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—Ç–∞—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–≤–µ—Ä—Å–∏—è 3 ‚Üí 8)
```typescript
// oldVersion = 3, newVersion = 8, MIN_CURRENT_VERSION = 7
// ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è LEGACY_MIGRATIONS_REGISTRY –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
// ‚úÖ –û–±—ä–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å MIGRATIONS_REGISTRY
// ‚úÖ –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –≤–µ—Ä—Å–∏–π 3-8
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã legacy/current
```typescript
// –í MIGRATIONS_REGISTRY.ts
export const MIN_CURRENT_VERSION = 7; // –í—Å–µ –≤–µ—Ä—Å–∏–∏ < 7 —Å—á–∏—Ç–∞—é—Ç—Å—è legacy
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ legacy –º–∏–≥—Ä–∞—Ü–∏–∏
```typescript
// –í LEGASY_MIGRATIONS_REGISTRY.ts
export const LEGACY_MIGRATIONS_REGISTRY: Record<number, string> = {
  2: '2_old_feature',
  3: '3_deprecated_store', 
  4: '4_legacy_indexes',
  5: '5_old_accounts_format',
  6: '6_legacy_rooms',
};
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
```typescript
// –í MIGRATIONS_REGISTRY.ts  
export const MIGRATIONS_REGISTRY: Record<number, string> = {
  7: '7_new_feature',
  8: '8_optimize_performance',
  9: '9_add_settings_store',
};
```

## üß™ API —Ñ—É–Ω–∫—Ü–∏–∏

### –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–µ—Å—Ç—Ä)
```typescript
// –ë—ã—Å—Ç—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞
getAvailableMigrations()    // –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
hasMigration(version)       // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–µ—Å—Ç—Ä–µ
getMaxVersion()             // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è legacy)  
```typescript
// –ü–æ–ª–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å legacy –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
await getCombinedAvailableMigrations()  // –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (legacy + current)
await hasCombinedMigration(version)     // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ –≤—Å–µ—Ö —Ä–µ–µ—Å—Ç—Ä–∞—Ö
await preloadMigrations(old, new)       // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—ã–µ —Ä–µ–µ—Å—Ç—Ä—ã
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ legacy**
   ```typescript
   const needsLegacy = oldVersion < MIN_CURRENT_VERSION;
   ```

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ legacy (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)**
   ```typescript
   const legacyRegistry = await loadLegacyRegistry();
   ```

3. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–µ—Å—Ç—Ä–æ–≤**
   ```typescript
   const combinedRegistry = { ...legacyRegistry, ...MIGRATIONS_REGISTRY };
   ```

4. **–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π –º–∏–≥—Ä–∞—Ü–∏–π**
   ```typescript
   const migrations = await preloadMigrations(oldVersion, newVersion);
   ```

5. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π**
   ```typescript
   runSchemaMigrations(db, oldVersion, newVersion, migrations);
   await runDataMigrations(db, oldVersion, newVersion, migrations, dbName);
   ```

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞

### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≥—Ä–∞–Ω–∏—Ü—É
```typescript
// –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Ä—Å–∏–∏ 1-6 —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ, 7+ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
const MIN_CURRENT_VERSION = 7;
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ legacy –º–∏–≥—Ä–∞—Ü–∏–∏
```typescript
// –ò–∑ MIGRATIONS_REGISTRY.ts –≤ LEGASY_MIGRATIONS_REGISTRY.ts
1: '1_old_accounts',
2: '2_legacy_rooms', 
// ... –¥–æ –≤–µ—Ä—Å–∏–∏ 6
```

### –®–∞–≥ 3: –û—á–∏—Å—Ç–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–µ—Å—Ç—Ä
```typescript
// –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
7: '7_new_feature',
8: '8_modern_indexes',
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç:
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ legacy —Ä–µ–µ—Å—Ç—Ä–∞**: `Legacy —Ä–µ–µ—Å—Ç—Ä –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ`  
- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞**: `–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä —Å–æ–∑–¥–∞–Ω`
- ‚ö° **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: `–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–µ—Å—Ç—Ä (legacy –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤**: Legacy –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
2. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò–∑–±–µ–≥–∞–π—Ç–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π –º–µ–∂–¥—É —Ä–µ–µ—Å—Ç—Ä–∞–º–∏
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ, —Ç–æ–ª—å–∫–æ legacy, —Å–º–µ—à–∞–Ω–Ω—ã–µ
4. **Backup**: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ–ø–∏–∏ before/after –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –º–∏–≥—Ä–∞—Ü–∏–π

---

*–û–±–Ω–æ–≤–ª–µ–Ω–æ: 7 —è–Ω–≤–∞—Ä—è 2025 | –°–∏—Å—Ç–µ–º–∞ legacy –º–∏–≥—Ä–∞—Ü–∏–π v1.0*
