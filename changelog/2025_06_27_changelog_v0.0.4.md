# Changelog v0.0.4 - 2025-06-27

## Изменения

### Исправление формата JSON на странице crypto
- **Восстановлен старый формат JSON**: На странице crypto при шифровании теперь возвращается JSON с полями `cipher` и `nonce` (вместо `cipherText` и `nonce`)

## Технические детали

### Измененные файлы
- `front/src/pages/crypto_page/ui/CryptoPageEncrypt.svelte` - исправлен формат возвращаемого JSON

### Изменения в логике шифрования

#### Шифрование с подписью (isVerifyEncrypt = true):
**Было:**
```json
{"nonce": "hex", "cipherText": "hex"}
```

**Стало:**
```json
{"cipher": "hex", "nonce": "hex"}
```

#### Простое шифрование (isVerifyEncrypt = false):
**Было:**
```json
"hex_строка"
```

**Стало:**
```json
{"cipher": "hex_строка"}
```

### Улучшения безопасности
- Добавлены проверки на null для результатов шифрования
- Добавлены уведомления об ошибках шифрования

## Код изменений

### Основная логика:
```typescript
if (isVerifyEncrypt) {
    const result = await encrypt_curve25519_verify({
        receiverPublicKey: partnerKey.publicKey,
        senderPrivateKey: myKey.privateKey,
        message: sourceMessage,
    });

    if (!result) {
        alert("Ошибка шифрования");
        return;
    }

    // Преобразуем формат {nonce, cipherText} в {cipher, nonce}
    encryptedText = JSON.stringify({
        cipher: result.cipherText,
        nonce: result.nonce,
    });
} else {
    const result = await encrypt_curve25519({
        receiverPublicKey: partnerKey.publicKey,
        message: sourceMessage,
    });

    if (!result) {
        alert("Ошибка шифрования");
        return;
    }

    // Для простого шифрования создаем JSON с cipher (без nonce)
    encryptedText = JSON.stringify({
        cipher: result,
    });
}
```

## Совместимость

### Обратная совместимость
- ✅ Новый формат совместим со старыми ожиданиями пользователя
- ✅ Сохранена вся функциональность шифрования
- ✅ Сохранена функциональность копирования и очистки

### Влияние на другие компоненты
- ❌ **Не влияет** на страницу Curve25519 (она использует свой формат)
- ❌ **Не влияет** на функции расшифровки
- ❌ **Не влияет** на сохранение ключей

## Текущий статус функциональности

### ✅ Полностью работает:
1. **Генерация ключей Curve25519** - работает
2. **Управление ключами** - работает + персистентность
3. **Шифрование на странице crypto** - работает + правильный JSON формат
4. **Шифрование на странице Curve25519** - работает
5. **Расшифровка сообщений** - работает
6. **Сохранение данных между сессиями** - работает

### Формат JSON по страницам:

#### Страница crypto (`/crypto`):
- С подписью: `{"cipher": "hex", "nonce": "hex"}`
- Без подписи: `{"cipher": "hex"}`

#### Страница Curve25519 (`/curve25519`):
- С подписью: `{"nonce": "hex", "cipherText": "hex"}`
- Без подписи: `"hex_строка"`

## Следующие задачи (без изменений)

### Высокий приоритет:
1. **Валидация ключей** - добавить проверку формата публичных ключей
2. **Toast-уведомления** - заменить alert() на современные уведомления

### Средний приоритет:
3. **Экспорт/импорт ключей** - сохранение и загрузка ключей из файлов
4. **Подтверждения критических операций** - дополнительные подтверждения для удаления

## Заметки
- Исправление выполнено по запросу пользователя для восстановления старого формата JSON
- Новая функциональность сохранена, но адаптирована под ожидаемый формат
- Добавлена дополнительная обработка ошибок для повышения надежности
