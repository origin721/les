# 🏗️ Архитектура Rust сервера

## 🔗 [← Назад к документации](../links.md)

## 📋 Обзор

Rust сервер представляет собой статический файловый сервер, построенный на основе Actix-web framework. Основная задача - раздача фронтенд приложения и поддержка SPA (Single Page Application) роутинга.

## 🎯 Основные принципы

### 1. Асинхронность
- Использует Tokio runtime для неблокирующих операций
- Все HTTP обработчики асинхронные
- Высокая производительность при работе с множественными подключениями

### 2. Thread-Safety
- Использует `Mutex` для безопасного доступа к разделяемым данным
- Все структуры данных thread-safe
- Поддержка многопоточной обработки запросов

### 3. Модульность
- Четкое разделение ответственности между модулями
- Переиспользуемые утилиты
- Легкость расширения функционала

## 🏛️ Структура приложения

```
┌─────────────────┐
│    main.rs      │  ← Точка входа
│                 │
│ ┌─────────────┐ │
│ │ AppParams   │ │  ← Конфигурация
│ └─────────────┘ │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  modules/mod.rs │  ← Основная логика
│                 │
│ ┌─────────────┐ │
│ │HTTP Server  │ │  ← Actix-web сервер
│ │             │ │
│ │ ┌─────────┐ │ │
│ │ │ Routes  │ │ │  ← Роутинг
│ │ └─────────┘ │ │
│ │             │ │
│ │ ┌─────────┐ │ │
│ │ │ Static  │ │ │  ← Статические файлы
│ │ └─────────┘ │ │
│ └─────────────┘ │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│   utils/mod.rs  │  ← Утилиты
│                 │
│ ┌─────────────┐ │
│ │File System  │ │  ← Работа с ФС
│ └─────────────┘ │
└─────────────────┘
```

## 🔧 Компоненты системы

### 1. main.rs - Точка входа
```rust
pub struct AppParams {
    port: u16,                           // Порт сервера
    relative_path_params: RelativePathParams, // Путь к статическим файлам
}
```

**Ответственность:**
- Инициализация параметров приложения
- Настройка пути к статическим файлам (`../dist`)
- Запуск основного модуля сервера

### 2. modules/mod.rs - HTTP сервер
```rust
pub struct AppStateWithCounter {
    counter: Mutex<i32>, // Thread-safe счетчик
}
```

**Ответственность:**
- Создание и настройка Actix-web приложения
- Конфигурация роутинга
- Обработка статических файлов
- SPA поддержка (fallback на index.html)

### 3. utils/mod.rs - Файловые утилиты
```rust
pub struct RelativePathParams {
    pub current_file: String,    // Текущий файл
    pub relative_path: String,   // Относительный путь
}
```

**Ответственность:**
- Рекурсивное чтение директорий
- Работа с абсолютными и относительными путями
- Чтение содержимого файлов

## 🌐 Поток обработки запросов

```
1. HTTP запрос → Actix-web сервер
                      │
2. Проверка статических файлов
                      │
3. Если файл найден → Возврат файла
                      │
4. Если файл НЕ найден → Возврат index.html (SPA)
```

### Детальный алгоритм:

1. **Инициализация сервера:**
   ```rust
   // Чтение всех файлов из dist директории
   let dist_utils = host_dist::create_dist_utils(params);
   
   // Поиск index.html для SPA fallback
   let index_html = dist_utils.find(|item| item.id == "/index.html");
   ```

2. **Обработка запроса:**
   ```rust
   // Попытка найти статический файл
   if static_file_exists(request_path) {
       return static_file_content;
   } else {
       return index_html; // SPA fallback
   }
   ```

## 🔄 Жизненный цикл приложения

```
Старт → Чтение конфигурации → Сканирование dist/ → 
Создание роутов → Запуск HTTP сервера → Обработка запросов
```

### Этапы инициализации:

1. **Конфигурация** (`main.rs`)
   - Создание `AppParams`
   - Настройка порта (8080)
   - Указание пути к статическим файлам

2. **Подготовка файлов** (`utils/mod.rs`)
   - Рекурсивное сканирование `../dist`
   - Чтение содержимого всех файлов
   - Создание карты файлов для быстрого доступа

3. **Настройка сервера** (`modules/mod.rs`)
   - Создание Actix-web приложения
   - Регистрация роутов для статических файлов
   - Настройка default handler для SPA

4. **Запуск** 
   - Привязка к адресу `127.0.0.1:8080`
   - Запуск асинхронного сервера

## 🚀 Режимы запуска

### Обычный режим: `cargo run`
- Стандартный запуск приложения
- Все логи выводятся в консоль
- Сервер работает до принудительной остановки

### Режим разработки: `cargo run dev`
- Аналогичен обычному режиму
- Дополнительные отладочные сообщения
- Возможность добавления hot-reload в будущем

## 🔧 Точки расширения

### 1. Добавление API эндпоинтов
```rust
// В modules/api/
pub fn configure_api(cfg: &mut web::ServiceConfig) {
    cfg.service(
        web::scope("/api")
            .route("/health", web::get().to(health_check))
    );
}
```

### 2. Middleware
```rust
// Добавление логирования, CORS, аутентификации
App::new()
    .wrap(Logger::default())
    .wrap(Cors::default())
```

### 3. Конфигурация
```rust
// Расширение AppParams для новых настроек
pub struct AppParams {
    port: u16,
    host: String,           // Новое поле
    ssl_enabled: bool,      // Новое поле
    // ...
}
```

## 📊 Производительность

### Преимущества архитектуры:
- **Асинхронность**: Неблокирующая обработка запросов
- **Zero-copy**: Эффективная работа с памятью
- **Кэширование**: Файлы читаются один раз при старте
- **Thread-safety**: Безопасная многопоточность

### Метрики:
- Время старта: ~100-500ms (зависит от размера dist/)
- Память: Базовое потребление + размер всех статических файлов
- Пропускная способность: Ограничена только Actix-web

## 🔍 Отладка и мониторинг

### Логирование:
```rust
println!("Started server: {}", params.port);
print!("MY_RESLLL: {}", result); // Отладочные сообщения
```

### Точки мониторинга:
- Счетчик запросов (`AppStateWithCounter`)
- Время обработки запросов
- Использование памяти
- Статус файловой системы

---

**📚 Связанные документы:**
- [README.md](../README.md) - Основная документация
- [links.md](../links.md) - Навигация
- [Cargo.toml](../Cargo.toml) - Зависимости
